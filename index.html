<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trésorerie Club</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Styles CSS (LAISSÉS INCHANGÉS) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            padding: 20px 20px 40px;
            text-align: center;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        
        .header h1 {
            margin-bottom: 5px;
            font-size: 1.5em;
        }

        .balance-card {
            background: white;
            padding: 15px;
            margin: -20px 20px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .balance-card h2 {
            font-size: 1em;
            color: #777;
            margin-bottom: 5px;
        }

        .balance-card p {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid #eee;
        }

        .tab-button {
            flex-grow: 1;
            padding: 15px 10px;
            text-align: center;
            background: #f8f8f8;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            color: #777;
            transition: background 0.3s, color 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            padding: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        form {
            display: grid;
            gap: 15px;
        }

        form label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }

        form input, form select, form button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        form button {
            background: #667eea;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        form button:hover {
            background: #5a6edb;
        }
        
        .transaction-list, .member-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .transaction-item, .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .transaction-item:last-child, .member-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-description {
            font-weight: bold;
            color: #333;
        }

        .item-date, .item-category, .item-status {
            font-size: 0.8em;
            color: #777;
        }

        .item-amount {
            font-weight: bold;
            font-size: 1.1em;
        }

        .recette .item-amount {
            color: #28a745; /* Vert pour recette */
        }

        .depense .item-amount {
            color: #dc3545; /* Rouge pour dépense */
        }

        .member-item-info {
            flex-grow: 1;
        }
        
        .member-item-name {
            font-weight: bold;
            color: #333;
        }

        .member-item-status {
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .status-paid {
            color: #28a745;
            font-weight: bold;
        }

        .status-unpaid {
            color: #dc3545;
            font-weight: bold;
        }

        .member-actions {
            display: flex;
            gap: 10px;
        }
        
        .member-actions button, .transaction-item button {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            color: #555;
        }

        .member-actions .toggle-pay-btn.paid {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .member-actions .toggle-pay-btn.unpaid {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .admin-controls {
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .admin-controls h3 {
            margin-bottom: 15px;
            color: #555;
        }
        
        .control-group {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .control-group button {
            flex-grow: 1;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .control-group button:nth-child(2) {
            background: #f44336;
        }
        
        .sync-status {
            text-align: center;
            font-size: 0.8em;
            padding: 10px;
            color: #777;
        }
        
        .sync-status.success {
            color: #28a745;
        }
        
        .sync-status.error {
            color: #dc3545;
        }
        
        .config-panel h3 {
            margin-bottom: 10px;
        }

        .config-panel p {
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #777;
        }
        
        .config-panel input[type="text"] {
            margin-bottom: 10px;
        }
        
        /* Styles pour les nouveaux boutons dans le panneau de configuration */
        .config-buttons {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            margin-top: 20px;
        }
        
        .config-buttons button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .config-buttons button:hover {
            opacity: 0.9;
        }
        
        .config-buttons button.danger {
            background: #dc3545;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gestion de Trésorerie</h1>
        </div>
        
        <div class="balance-card">
            <h2>Solde Actuel</h2>
            <p id="currentBalance">0.00 DT</p>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="transactions">Transactions</button>
            <button class="tab-button" data-tab="members">Membres</button>
            <button class="tab-button" data-tab="config">Configuration</button>
        </div>

        <div class="sync-status" id="syncStatus">Non Synchronisé</div>

        <div class="tab-content" id="tab-dashboard">
            <h2>Ajouter une Transaction</h2>
            <form id="addTransactionForm">
                <label for="transactionType">Type</label>
                <select id="transactionType" required>
                    <option value="recette">Recette</option>
                    <option value="depense">Dépense</option>
                </select>

                <label for="description">Description</label>
                <input type="text" id="description" placeholder="Ex: Cotisation, Achat matériel" required>

                <label for="amount">Montant (DT)</label>
                <input type="number" id="amount" step="0.01" required>
                
                <label for="category">Catégorie</label>
                <select id="category" required>
                    <option value="cotisation">Cotisation</option>
                    <option value="evenement">Événement</option>
                    <option value="fourniture">Fourniture</option>
                    <option value="autre">Autre</option>
                </select>

                <label for="transactionDate">Date</label>
                <input type="date" id="transactionDate" required>

                <button type="submit">Ajouter Transaction</button>
            </form>
            
            <hr style="margin: 20px 0;">
            
            <h2>Rapport Rapide</h2>
            <p id="summaryText"></p>
        </div>

        <div class="tab-content hidden" id="tab-transactions">
            <h2>Historique des Transactions</h2>
            <ul class="transaction-list" id="transactionList">
                </ul>
            <div class="control-group" style="margin-top: 20px;">
                <button onclick="exportTransactionsPDF()">Exporter PDF</button>
            </div>
        </div>
        
        <div class="tab-content hidden" id="tab-members">
            <h2>Liste des Membres</h2>
            <ul class="member-list" id="memberList">
                </ul>
            
            <hr style="margin: 20px 0;">

            <h2>Ajouter un Membre</h2>
            <form id="addMemberForm">
                <label for="firstName">Prénom</label>
                <input type="text" id="firstName" required>

                <label for="lastName">Nom</label>
                <input type="text" id="lastName" required>

                <label for="cotisationAmount">Montant Cotisation</label>
                <input type="number" id="cotisationAmount" step="0.01" required value="20.00">

                <button type="submit">Ajouter Membre</button>
            </form>
        </div>
        
        <div class="tab-content hidden" id="tab-config">
            <div class="config-panel">
                <h2>Panneau de Configuration</h2>
                
                <hr style="margin: 20px 0;">

                <h3>Accès Administrateur</h3>
                <p>Basculer entre les modes Administrateur (écriture) et Visiteur (lecture seule).</p>
                <button id="toggleAdminBtn" style="background: #ffc107; color: black;" onclick="toggleAdminAccess()">Activer Mode Admin</button>

                <hr style="margin: 20px 0;">

                <h3>Rapports & Exports</h3>
                <div class="config-buttons">
                    <button onclick="exportFinancialReportPDF()">Rapport Financier PDF</button>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <h3>Maintenance de la Base de Données</h3>
                <p style="color: #dc3545;">Ces boutons sont DANGEREUX. Ils effacent les données de la base de données Firebase.</p>
                <div class="config-buttons">
                    <button class="danger" onclick="clearAllTransactions()">Vider Transactions</button>
                    <button class="danger" onclick="clearAllMembers()">Vider Membres</button>
                </div>

            </div>
        </div>
        
    </div>

    <script>
        // =================================================================
        //                 FIREBASE CONFIGURATION & INIT
        // =================================================================
        
        // !!! REMPLACER CES CLÉS AVEC VOS PROPRES INFOS FIREBASE !!!
        const firebaseConfig = {
                apiKey: "AIzaSyAOFzbsKa6b9_9XMPNiP8VDJdhnuTqGyh0",
                authDomain: "caisse-club.firebaseapp.com",
                projectId: "caisse-club",
                storageBucket: "caisse-club.firebasestorage.app",
                messagingSenderId: "410619067499",
                appId: "1:410619067499:web:5ae5a65a645c4b1634052e",
                measurementId: "G-PEVSBVTZWV"
            };

        // Initialisation de l'application Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        
        // Références aux collections Firestore
        const TRANSACTIONS_COLLECTION = db.collection("transactions");
        const MEMBERS_COLLECTION = db.collection("members");
        
        // =================================================================
        //                 VARIABLES GLOBALES & PERSISTANCE CONFIG
        // =================================================================

        let config = JSON.parse(localStorage.getItem('treasuryConfig')) || {
            isAdmin: false,
            lastTab: 'dashboard'
        };
        // Les données seront initialisées par Firebase, pas par localStorage
        let transactions = [];
        let members = [];
        let autoSyncInterval;

        // Fonction pour sauvegarder les paramètres non-data (isAdmin, lastTab)
        function saveConfig() {
            localStorage.setItem('treasuryConfig', JSON.stringify(config));
            updateAdminUI();
        }
        
        // Fonction pour charger les paramètres non-data
        function loadConfig() {
            // Fait partie de l'initialisation de 'config'
            updateAdminUI();
        }
        
        // =================================================================
        //                 FONCTIONS DE PERSISTANCE FIREBASE
        // =================================================================
        
        // CHARGER TOUTES LES DONNÉES DE FIREBASE
        async function loadFromFirestore() {
            updateSyncStatus('loading', 'Chargement depuis Firebase...');
            
            try {
                // --- 1. Charger les Transactions ---
                // Ordonné par date de création (timestamp)
                const transactionsSnapshot = await TRANSACTIONS_COLLECTION.orderBy("timestamp", "desc").get();
                transactions = transactionsSnapshot.docs.map(doc => ({
                    id: doc.id, 
                    ...doc.data(),
                    amount: parseFloat(doc.data().amount || 0),
                    // S'assurer que les valeurs numériques sont bien des nombres
                }));
                
                // --- 2. Charger les Membres ---
                const membersSnapshot = await MEMBERS_COLLECTION.get();
                members = membersSnapshot.docs.map(doc => ({
                    id: doc.id, 
                    ...doc.data(),
                    cotisationAmount: parseFloat(doc.data().cotisationAmount || 0),
                    paid: doc.data().paid === true || doc.data().paid === 'true' // Assurer un booléen
                }));
                
                updateUI();
                updateSyncStatus('success', `Synchronisé - ${new Date().toLocaleTimeString('fr-FR')}`);
                
            } catch (error) {
                console.error('Erreur de chargement Firebase:', error);
                updateSyncStatus('error', 'Erreur de synchronisation Firebase. Vérifiez la console.');
            }
        }
        
        // CRÉER/AJOUTER UNE NOUVELLE TRANSACTION
        async function addTransactionToFirestore(newTransaction) {
            if (!config.isAdmin) return;
            try {
                // Supprimer l'ID local temporaire avant d'ajouter
                const { id, ...dataToSave } = newTransaction; 
                
                const docRef = await TRANSACTIONS_COLLECTION.add(dataToSave);
                
                // Mettre à jour l'ID de la transaction locale avec l'ID Firestore généré
                const localIndex = transactions.findIndex(t => t.timestamp === newTransaction.timestamp && t.description === newTransaction.description);
                if (localIndex !== -1) {
                     transactions[localIndex].id = docRef.id;
                }
                
                updateSyncStatus('success', 'Transaction ajoutée à distance.');
            } catch (error) {
                console.error('Erreur d\'ajout transaction:', error);
                updateSyncStatus('error', 'Échec de l\'ajout de la transaction.');
            }
        }
        
        // METTRE À JOUR LE STATUT D'UN MEMBRE
        async function updateMemberInFirestore(memberId, paidStatus, newTimestamp) {
            if (!config.isAdmin) return;
            try {
                await MEMBERS_COLLECTION.doc(memberId).update({
                    paid: paidStatus,
                    lastPaymentDate: newTimestamp
                });
                updateSyncStatus('success', 'Statut du membre mis à jour à distance.');
            } catch (error) {
                console.error('Erreur de mise à jour membre:', error);
                updateSyncStatus('error', 'Échec de la MAJ du membre.');
            }
        }

        // CRÉER/AJOUTER UN NOUVEAU MEMBRE
        async function addMemberToFirestore(newMember) {
            if (!config.isAdmin) return;
            try {
                const docRef = await MEMBERS_COLLECTION.add(newMember);
                
                // Mettre à jour l'ID local
                const localIndex = members.findIndex(m => m.firstName === newMember.firstName && m.lastName === newMember.lastName);
                if (localIndex !== -1) {
                    members[localIndex].id = docRef.id;
                }
                updateSyncStatus('success', 'Membre ajouté à distance.');
            } catch (error) {
                console.error('Erreur d\'ajout membre:', error);
                updateSyncStatus('error', 'Échec de l\'ajout du membre.');
            }
        }
        
        // SUPPRIMER UNE TRANSACTION
        async function deleteTransactionFromFirestore(docId) {
            if (!config.isAdmin) return;
            try {
                await TRANSACTIONS_COLLECTION.doc(docId).delete();
                updateSyncStatus('success', 'Transaction supprimée à distance.');
            } catch (error) {
                console.error('Erreur de suppression transaction:', error);
                updateSyncStatus('error', 'Échec de la suppression transaction.');
            }
        }
        
        // SUPPRIMER UN MEMBRE
        async function deleteMemberFromFirestore(docId) {
            if (!config.isAdmin) return;
            try {
                await MEMBERS_COLLECTION.doc(docId).delete();
                updateSyncStatus('success', 'Membre supprimé à distance.');
            } catch (error) {
                console.error('Erreur de suppression membre:', error);
                updateSyncStatus('error', 'Échec de la suppression membre.');
            }
        }


        // =================================================================
        //                 LOGIQUE DE BASE (AJUSTÉE)
        // =================================================================
        
        function init() {
            loadConfig(); // Charge les paramètres (isAdmin, lastTab)
            // Lancement du chargement des données depuis Firebase
            loadFromFirestore(); 
            startAutoSync();
            setCurrentDate(); // Initialise la date dans le formulaire
            
            // Écouteurs d'événements pour les boutons d'onglet
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.getAttribute('data-tab');
                    showTab(tab);
                });
            });
            
            showTab(config.lastTab);
        }

        // DÉMARRAGE DE LA SYNCHRONISATION AUTOMATIQUE
        function startAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            // Synchronise les données toutes les 30 secondes
            autoSyncInterval = setInterval(loadFromFirestore, 30000); 
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
            
            config.lastTab = tabName;
            saveConfig();
        }

        function updateSyncStatus(type, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.className = 'sync-status ' + type;
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('transactionDate');
            if (dateInput) {
                dateInput.value = today;
            }
        }

        function updateAdminUI() {
            const adminControls = document.querySelectorAll('.tab-content form button, .member-actions button, .config-buttons button');
            const toggleBtn = document.getElementById('toggleAdminBtn');
            const forms = document.querySelectorAll('form');
            
            if (config.isAdmin) {
                adminControls.forEach(el => el.disabled = false);
                toggleBtn.textContent = 'Désactiver Mode Admin (Activé)';
                toggleBtn.style.background = '#28a745';
                forms.forEach(form => form.style.opacity = '1');
            } else {
                // Désactiver les boutons d'action d'écriture
                adminControls.forEach(el => {
                    // Ne pas désactiver l'export PDF
                    if (el.textContent.indexOf('PDF') === -1) {
                        el.disabled = true;
                    }
                });
                toggleBtn.textContent = 'Activer Mode Admin (Désactivé)';
                toggleBtn.style.background = '#ffc107';
                forms.forEach(form => form.style.opacity = '0.7');
            }
        }

        function toggleAdminAccess() {
            config.isAdmin = !config.isAdmin;
            saveConfig();
            updateAdminUI();
            updateUI(); // Rafraîchit au cas où des éléments dépendent de l'accès
        }
        
        function calculateBalance() {
            let totalRecettes = 0;
            let totalDepenses = 0;
            
            transactions.forEach(t => {
                const amount = t.amount;
                if (t.type === 'recette') {
                    totalRecettes += amount;
                } else if (t.type === 'depense') {
                    totalDepenses += amount;
                }
            });

            const balance = totalRecettes - totalDepenses;
            
            document.getElementById('currentBalance').textContent = `${balance.toFixed(2)} DT`;
            
            // Texte de résumé
            const unpaidMembers = members.filter(m => !m.paid).length;
            const summaryText = `Total Recettes: ${totalRecettes.toFixed(2)} DT. Total Dépenses: ${totalDepenses.toFixed(2)} DT. ${unpaidMembers} membre(s) en attente de cotisation.`;
            document.getElementById('summaryText').textContent = summaryText;
        }

        function updateUI() {
            calculateBalance();
            renderTransactions();
            renderMembers();
        }

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            list.innerHTML = ''; // Vider la liste
            
            transactions.forEach(t => {
                const listItem = document.createElement('li');
                listItem.className = `transaction-item ${t.type}`;
                
                const deleteBtn = `<button onclick="deleteTransaction('${t.id}')" ${config.isAdmin ? '' : 'disabled'}>Supprimer</button>`;
                
                listItem.innerHTML = `
                    <div class="item-info">
                        <div class="item-description">${t.description}</div>
                        <div class="item-details">
                            <span class="item-date">${t.date}</span> |
                            <span class="item-category">${t.category}</span>
                        </div>
                    </div>
                    <div class="item-amount">${(t.type === 'recette' ? '+' : '-')}${t.amount.toFixed(2)} DT</div>
                    ${deleteBtn}
                `;
                
                list.appendChild(listItem);
            });
        }
        
        function renderMembers() {
            const list = document.getElementById('memberList');
            list.innerHTML = ''; // Vider la liste
            
            members.sort((a, b) => a.lastName.localeCompare(b.lastName)); // Tri alphabétique
            
            members.forEach(m => {
                const listItem = document.createElement('li');
                listItem.className = 'member-item';
                
                const statusClass = m.paid ? 'status-paid' : 'status-unpaid';
                const buttonClass = m.paid ? 'paid' : 'unpaid';
                const buttonText = m.paid ? 'Marquer Impayé' : 'Marquer Payé';
                
                const memberActions = `
                    <div class="member-actions">
                        <button class="toggle-pay-btn ${buttonClass}" onclick="togglePayment('${m.id}', ${m.paid}, ${m.cotisationAmount})" ${config.isAdmin ? '' : 'disabled'}>${buttonText}</button>
                        <button onclick="deleteMember('${m.id}')" ${config.isAdmin ? '' : 'disabled'}>Supprimer</button>
                    </div>
                `;
                
                listItem.innerHTML = `
                    <div class="member-item-info">
                        <div class="member-item-name">${m.firstName} ${m.lastName}</div>
                        <div class="member-item-status">Cotisation: ${m.cotisationAmount.toFixed(2)} DT | <span class="${statusClass}">${m.paid ? 'Payé' : 'Impayé'}</span></div>
                    </div>
                    ${memberActions}
                `;
                
                list.appendChild(listItem);
            });
        }
        
        // =================================================================
        //                 ACTIONS SUR LES DONNÉES (AJUSTÉES FIREBASE)
        // =================================================================

        // HANDLER POUR AJOUTER UNE TRANSACTION
        document.getElementById('addTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!config.isAdmin) return alert("Vous n'êtes pas en mode Administrateur.");

            const newTransaction = {
                // ID est temporaire, Firestore le remplacera
                id: Date.now().toString(), 
                type: document.getElementById('transactionType').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('transactionDate').value,
                timestamp: new Date().toISOString() // Horodatage pour tri et référence
            };

            transactions.unshift(newTransaction); // Ajouter en haut localement
            addTransactionToFirestore(newTransaction); // Envoyer à Firebase
            
            updateUI();
            this.reset();
            setCurrentDate();
        });
        
        // HANDLER POUR AJOUTER UN MEMBRE
        document.getElementById('addMemberForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!config.isAdmin) return alert("Vous n'êtes pas en mode Administrateur.");
            
            const newMember = {
                id: Date.now().toString(), // ID local temporaire
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                cotisationAmount: parseFloat(document.getElementById('cotisationAmount').value),
                paid: false,
                lastPaymentDate: null
            };

            members.push(newMember); // Ajouter localement
            addMemberToFirestore(newMember); // Envoyer à Firebase
            
            updateUI();
            this.reset();
        });

        // HANDLER POUR MARQUER PAYÉ/IMPAYÉ
        function togglePayment(memberId, isCurrentlyPaid, cotisationAmount) {
            if (!config.isAdmin) return alert("Vous n'êtes pas en mode Administrateur.");
            
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            const newPaidStatus = !isCurrentlyPaid;
            const nowIso = new Date().toISOString();
            
            // 1. Gérer la transaction de cotisation
            const transactionDescription = `Cotisation ${member.firstName} ${member.lastName}`;
            
            if (newPaidStatus) {
                // Ajouter la transaction (Recette)
                const newTransaction = {
                    id: Date.now().toString(), 
                    type: 'recette',
                    description: transactionDescription,
                    amount: cotisationAmount,
                    category: 'cotisation',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: nowIso
                };
                transactions.unshift(newTransaction);
                addTransactionToFirestore(newTransaction);

            } else {
                // Si on marque impayé, on cherche et supprime la transaction de cotisation la plus récente
                const indexToRemove = transactions.findIndex(t => 
                    t.description === transactionDescription && 
                    t.type === 'recette' && 
                    t.amount === cotisationAmount
                );

                if (indexToRemove !== -1) {
                    const docIdToRemove = transactions[indexToRemove].id;
                    transactions.splice(indexToRemove, 1);
                    deleteTransactionFromFirestore(docIdToRemove);
                }
            }
            
            // 2. Mettre à jour le statut du membre localement
            member.paid = newPaidStatus;
            member.lastPaymentDate = newPaidStatus ? nowIso : null;

            // 3. Mettre à jour le statut du membre dans Firebase
            updateMemberInFirestore(member.id, member.paid, member.lastPaymentDate);
            
            updateUI();
        }

        // SUPPRIMER UNE TRANSACTION
        function deleteTransaction(transactionId) {
            if (!config.isAdmin) return alert("Vous n'êtes pas en mode Administrateur.");
            
            if (confirm('Êtes-vous sûr de vouloir supprimer cette transaction ?')) {
                const index = transactions.findIndex(t => t.id === transactionId);
                
                if (index !== -1) {
                    // 1. Supprimer dans Firebase
                    deleteTransactionFromFirestore(transactionId);
                    
                    // 2. Supprimer localement
                    transactions.splice(index, 1); 
                    updateUI();
                }
            }
        }
        
        // SUPPRIMER UN MEMBRE
        function deleteMember(memberId) {
            if (!config.isAdmin) return alert("Vous n'êtes pas en mode Administrateur.");

            const member = members.find(m => m.id === memberId);
            if (!member) return;

            if (confirm(`Êtes-vous sûr de vouloir supprimer ${member.firstName} ${member.lastName} ?`)) {
                const memberIndex = members.findIndex(m => m.id === memberId);

                if (memberIndex !== -1) {
                    // 1. Supprimer dans Firebase
                    deleteMemberFromFirestore(memberId);
                    
                    // 2. Supprimer localement
                    members.splice(memberIndex, 1);
                    updateUI();
                }
            }
        }
        
        // =================================================================
        //                 FONCTIONS DE MAINTENANCE/CLEANUP
        // =================================================================

        // Fonction pour effacer toutes les transactions
        function clearAllTransactions() {
            if (!config.isAdmin || !confirm("Êtes-vous SÛR de vouloir effacer TOUTES les transactions ? Cette action est irréversible !")) return;

            // Firebase ne permet pas la suppression de collection entière via le client, 
            // il faut itérer et supprimer par lot ou utiliser une Cloud Function.
            // Pour ce code client simple, nous allons supprimer un par un.
            updateSyncStatus('loading', 'Suppression de toutes les transactions...');
            
            const deletePromises = transactions.map(t => TRANSACTIONS_COLLECTION.doc(t.id).delete());

            Promise.all(deletePromises)
                .then(() => {
                    transactions = []; // Vider localement
                    updateUI();
                    updateSyncStatus('success', 'Toutes les transactions ont été effacées.');
                })
                .catch(error => {
                    console.error("Erreur lors de la suppression des transactions: ", error);
                    updateSyncStatus('error', 'Erreur lors de la suppression des transactions.');
                });
        }
        
        // Fonction pour effacer tous les membres
        function clearAllMembers() {
            if (!config.isAdmin || !confirm("Êtes-vous SÛR de vouloir effacer TOUS les membres ? Cette action est irréversible !")) return;

            updateSyncStatus('loading', 'Suppression de tous les membres...');

            const deletePromises = members.map(m => MEMBERS_COLLECTION.doc(m.id).delete());

            Promise.all(deletePromises)
                .then(() => {
                    members = []; // Vider localement
                    updateUI();
                    updateSyncStatus('success', 'Tous les membres ont été effacés.');
                })
                .catch(error => {
                    console.error("Erreur lors de la suppression des membres: ", error);
                    updateSyncStatus('error', 'Erreur lors de la suppression des membres.');
                });
        }
        
        
        // =================================================================
        //                 FONCTIONS PDF (LAISSÉES INCHANGÉES)
        // =================================================================
        
        function exportFinancialReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('Rapport Financier', 20, 30);
            
            doc.setFontSize(12);
            doc.text(`Date du Rapport: ${new Date().toLocaleDateString('fr-FR')}`, 20, 45);

            let totalRecettes = 0;
            let totalDepenses = 0;
            const categorySummary = {};

            transactions.forEach(t => {
                const amount = t.amount;
                const category = t.category;

                if (!categorySummary[category]) {
                    categorySummary[category] = { recettes: 0, depenses: 0 };
                }

                if (t.type === 'recette') {
                    totalRecettes += amount;
                    categorySummary[category].recettes += amount;
                } else if (t.type === 'depense') {
                    totalDepenses += amount;
                    categorySummary[category].depenses += amount;
                }
            });

            const balance = totalRecettes - totalDepenses;

            doc.setFontSize(14);
            doc.text('Synthèse Globale', 20, 60);
            doc.setFontSize(12);
            doc.text(`Total Recettes: ${totalRecettes.toFixed(2)} DT`, 20, 70);
            doc.text(`Total Dépenses: ${totalDepenses.toFixed(2)} DT`, 20, 80);
            doc.text(`Solde Net: ${balance.toFixed(2)} DT`, 20, 90);
            
            doc.setFontSize(14);
            doc.text('Synthèse par Catégorie', 20, 110);
            
            const tableData = Object.keys(categorySummary).map(category => {
                const summary = categorySummary[category];
                const solde = summary.recettes - summary.depenses;
                return [
                    category.charAt(0).toUpperCase() + category.slice(1),
                    summary.recettes.toFixed(2) + ' DT',
                    summary.depenses.toFixed(2) + ' DT',
                    solde.toFixed(2) + ' DT'
                ];
            });

            doc.autoTable({
                startY: 120,
                head: [['Catégorie', 'Recettes', 'Dépenses', 'Solde']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [66, 133, 244] }
            });

            doc.save('rapport_financier.pdf');
        }

        function exportTransactionsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('Historique des Transactions', 20, 30);
            
            doc.setFontSize(12);
            doc.text(`Date d'export: ${new Date().toLocaleDateString('fr-FR')}`, 20, 45);

            const tableData = transactions.map(transaction => [
                transaction.date,
                transaction.description,
                transaction.category,
                transaction.type === 'recette' ? 'Recette' : 'Dépense',
                `${transaction.amount.toFixed(2)} DT`
            ]);

            doc.autoTable({
                startY: 60,
                head: [['Date', 'Description', 'Catégorie', 'Type', 'Montant']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [66, 133, 244] }
            });

            doc.save('historique_transactions.pdf');
        }


        // INITIALISATION AU CHARGEMENT DE LA PAGE
        window.onload = init;
    </script>
</body>
</html>